name: Train ML Model

# Trigger this workflow whenever code is pushed to the main branch.  The
# pipeline tests and trains your ML model, builds and pushes a Docker
# image containing the serving layer, and finally deploys the serving
# layer to an Azure Kubernetes Service (AKS) cluster.  The deployment
# job uses Azure‑specific actions instead of the Google Cloud actions
# previously used.
on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  # Run linting, static analysis, tests and a SonarQube scan.  This
  # job checks out the code, installs the Python dependencies, runs
  # pytest and executes the SonarQube scan using your project and
  # organization settings.
  test_code_analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Test with pytest
        run: |
          pytest

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=technoavengers_ci_cd_dockers
            -Dsonar.organization=technoavengers
            -Dsonar.sources=.
            -Dsonar.branch.name=main
            -Dsonar.python.coverage.reportPaths=coverage.xml

  # Train your machine learning model.  This job depends on the
  # successful completion of the test_code_analysis job.  It checks out
  # the code, installs dependencies, runs the training script and
  # stores the generated model artefacts as a workflow artifact.
  train_model:
    needs: test_code_analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v3
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Train the model
        run: |
          python training/training.py
          mkdir -p artifacts
          mv /tmp/random_forest_model.pkl ./artifacts/random_forest_model.pkl
          mv /tmp/scaler.pkl ./artifacts/scaler.pkl

      - name: Save the trained model as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: ./artifacts/

  # Build a Docker image for the serving layer and push it to
  # Docker Hub.  This job runs after the model is trained.  It
  # downloads the trained model artifact, installs the necessary
  # dependencies, logs into Docker Hub using secrets, builds the Docker
  # image using your Dockerfile and pushes it to your Docker Hub
  # repository.
  create_serving_layer:
    needs: train_model
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download trained model artifact
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: ./artifacts/

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build Docker Image
        run: |
          docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/model_serving:latest .

      - name: Push Docker Image
        run: |
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/model_serving:latest


  deploy_serving_layer:
    needs: create_serving_layer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name mycluster --region us-west-2

      - name: Test kubectl
        run: kubectl get nodes